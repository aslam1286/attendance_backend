{% extends 'base.html' %}

{% load static %}

{% block title %}Profile{% endblock %}

{% block content_title %}AttendanceList{% endblock %}

{% block extra_head %}
<style>

</style>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css">
<link href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">

{% endblock %}

{% block content %}
{% csrf_token %}
<div class="d-flex flex-column flex-root">
    <div class="container mt-5">
        <div class="row">
            <div class="col-sm-6">
                <div class="card">
                    <div class="card-header fw-bolder text-center" style="background-color: #e3f2fd;">
                        Employee Profile
                    </div>
                    <div class="card-body text-center">
                        <div class="container">
                            <img src="{% static 'admin/img/logo.png' %}" height="50px" />
                            <div class="row mt-3 text-center">
                                <h4 class="text text-center" style="color: #0a87a3;">{{user.first_name}} {{user.last_name}}</h4>
                                <span class="text text-center" style="color: #0a87a3;">Software Developer</span>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                {% csrf_token %}
                <div class="card">
                    <div class="card-header fw-bolder text-center" style="background-color: #e3f2fd;">
                        Attendance Report
                    </div>
                    <div class="card-body">
                        <div id="clock"></div>
                        <div class="container">
                            <div class="row">
                                <div class="col-md-8">
                                    <span>Please select month to download report.</span>
                                </div>
                                <div class="col-md-4">
                                    <select id="months" my-id="{{user.id}}" class="form-control">
                                        <option value="" selected>Select Month...</option>
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">Septeber</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                            </div>
                            <table id="month_reports" class="table table-light align-middle mt-3 fs-6 gy-5">
                                <thead>
                                    <tr class="table-info">
                                        <th class="text-center">Date</th>
                                        <th class="text-center">From Time</th>
                                        <th class="text-center">To Time</th>
                                        <th class="text-center">Total Time</th>
                                    </tr>
                                </thead>
                                <tbody class="text-gray-600 fw-bold text-center" id="t-body"></tbody>
                            </table>
                        </div>
                        <div id="downloadRepo" class="text text-center"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}

<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.min.js"></script>

<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>

<script type="text/javascript">

    $(document).ready(function () {
        $("#months").change(function (event) {
            $("#month_reports").DataTable().destroy();
            var monthsVal = $(this).val();
            var user_id = $(this).attr('my-id');
            $(".dt-buttons").empty();

            $.ajax({
                type: "POST",
                data: {
                    id: user_id,
                    mnt: monthsVal,
                    csrfmiddlewaretoken: $('[name="csrfmiddlewaretoken"]').val()
                },
                url: "{% url 'attendance_app:get_months_report' %}",
                success: function (response) {
                    var repo = response.month_reports;
                    $("div#downloadRepo").empty();
                    $('#month_reports tbody').empty();
                    
                    $.each(repo, function (i) {
                        $('#month_reports tbody').append('<tr><td>' + repo[i].today_date + '</td><td>' + repo[i].from_time + '</td><td>' + repo[i].to_time + '</td><td>' + repo[i].total_time + '</td></tr>');
                        
                    });
                    $(".dt-buttons").empty();
                    if($("tbody").children().length === 0){
                        Swal.fire('There is no any data available.');
                    }
                    else{
                        $("div#downloadRepo").append('<button type="button" class="btn btn-primary" onclick="downloadReports(this)">Download</button>')
                    }                    
                },
            });
        });
    });
    function downloadReports(e){
        $("#downloadRepo.text").text("");
        $("#month_reports").DataTable({
            searching: false, paging: false, info: false,
            dom: 'Bfrtip',
            buttons: [
                'csv', 'excel', 'pdf', 'print'
            ],
            "bDestroy": true
        });
        $("#downloadRepo").append($(".dt-button"));
        $(".dt-button").css({
            marginLeft: "11px",

        });
        $(".dt-button").addClass("btn btn-primary");

        }

</script>
{% endblock %}